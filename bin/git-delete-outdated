#!/usr/bin/env ruby

require 'open3'
require 'shellwords'

class DeleteOutdated
  def main
    local_branches.each do |branch|
      command = "git rev-parse --symbolic-full-name #{Shellwords.shellescape(branch)}@{u}"

      Open3.popen2e(command) do |_, stdout_and_err, wait_thr|
        base_branch_name = base_remote_branch_name(stdout_and_err.read.strip)

        if !wait_thr.value.success? || base_branch_name == "origin/master"
          suggest_delete_branch(branch)
        end
      end
    end
  end

  private

  def base_remote_branch_name(branch)
    branch.gsub(%r[.*/remotes/], '')
  end

  def local_branches
    `git for-each-ref refs/heads`.lines.map(&:strip).map do |line|
      line.split(' ')[2].gsub(%r{refs/heads/}, '')
    end.reject do |branch|
      branch == "master"
    end
  end

  def suggest_delete_branch(branch)
    $stdout.write "#{branch}. Delete [yN]? "
    response = gets.strip

    if response.downcase == 'y'
      `git branch -D #{Shellwords.shellescape(branch)}`
      puts 'Deleting'
    end
  end
end

DeleteOutdated.new.main
