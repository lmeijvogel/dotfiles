#!/bin/bash

pushd $HOME/git

  echo
  pushd neovim
    echo "Building neovim"
    git pull
    make distclean

    if [[ "$?" -ne "0" ]]; then
      echo "Error cleaning neovim"
      exit 1
    fi

    CMAKE_BUILD_TYPE=RelWithDebInfo make -j4
  popd

  if [[ "$?" -ne "0" ]]; then
    echo "Error building neovim"
    exit 1
  fi

  echo
  pushd neovim-qt
    echo "Building neovim-qt"
    git pull
    mkdir -p build
    cd build
    rm -rf *
    cmake -DCMAKE_BUILD_TYPE=Release ..
    make
  popd

  if [[ "$?" -ne "0" ]]; then
    echo "Error building neovim-qt"
    exit 1
  fi

  echo
  pushd neovim
    echo "Installing neovim"
    sudo make install

    # Clean up afterwards. This is necessary because `make install` actually creates these directories
    # with additional contents. Since it runs as root, these directories are owned by root and can't be
    # deleted without sudo.

    # When this `rm` is run, the sudo password is probably still cached and doesn't have to be asked again.
    sudo rm -rf $HOME/git/neovim/{.deps,build}
  popd

  echo
  pushd neovim-qt/build
    echo "Installing neovim-qt"

    sudo make install
  popd
popd
